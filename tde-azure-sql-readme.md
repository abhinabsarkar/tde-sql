# Azure SQL TDE with customer-managed key
With customer-managed transparent data encryption, customer is responsible for and in a full control of a key lifecycle management (key creation, upload, rotation, deletion), key usage permissions, and auditing of operations on keys.

In this scenario, the key used for encryption of the Database Encryption Key (DEK), called **TDE protector**, is a customer-managed asymmetric key stored in Azure Key Vault (AKV). It doesn't allow direct access to a stored key, but provides services of encryption/decryption using the key to the authorized entities. The key can be generated by the key vault, imported, or transferred to the key vault from an on-prem HSM device.

## How TDE works for Azure SQL?
TDE performs real-time I/O encryption and decryption of the data at the page level. Each page is decrypted when it's read into memory and then encrypted before being written to disk. TDE encrypts the storage of an entire database by using a **symmetric key (one key used for encryption & decryption)** called the Database Encryption Key (DEK). On database startup, the encrypted DEK is decrypted and then used for decryption and re-encryption of the database files in the SQL Server database engine process. DEK is protected by the TDE protector. TDE protector is either a service-managed certificate (service-managed transparent data encryption) or an asymmetric key stored in Azure Key Vault (customer-managed transparent data encryption).

**For Azure SQL Database and Azure Synapse Analytics, the TDE protector is set at the server level and is inherited by all encrypted databases associated with that server. For Azure SQL Managed Instance, the TDE protector is set at the instance level and is inherited by all encrypted databases on that instance.**

> For those using service-managed TDE who would like to start using customer-managed TDE, data remains encrypted during the process of switching over, and there is no downtime nor re-encryption of the database files. Switching from a service-managed key to a customer-managed key only requires re-encryption of the DEK, which is a fast and online operation.

![Alt text](/images/tde-sm-vs-cm.png)

## How customer-managed TDE works?
![Alt text](/images/customer-managed-tde-with-roles.png)

For server to be able to use TDE protector stored in AKV for encryption of the DEK, key vault administrator needs to give the following access rights to the server using its unique Azure Active Directory (Azure AD) identity:
* get - for retrieving the public part and properties of the key in the Key Vault
* wrapKey - to be able to encrypt DEK
* unwrapKey - to be able to decrypt DEK

When server is configured to use a TDE protector from AKV, the server sends the DEK of each TDE-enabled database to the key vault for encryption. Key vault returns the encrypted DEK, which is then stored in the user database. When needed, server sends protected DEK to the key vault for decryption.

## Enable TDE with BYOK from AKV
Enable TDE on Azure SQL Server & DB with customer-managed key from Azure Key Vault. Refer the [link](https://docs.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-byok-configure?tabs=azure-cli)

### 1. Create Azure SQL Server & Azure SQL DB
```bash
# create Azure SQL server (with system assigned identity)
az sql server create -n sqlserver-abs -g rg-sqlserver-tde -u <user> -p <password> --assign-identity --no-wait --debug
# Create Azure SQL DB 
az sql db create -n sqldb-abs -s sqlserver-abs -g rg-sqlserver-tde --no-wait --debug
```
### 2. Create Key vault & grant permissions to system identity of SQL Server on Key Vault keys 
```bash
# create key vault
az keyvault create -n kv-sqlserver-tde -g rg-sqlserver-tde --sku Premium --enable-soft-delete true --debug
# Create Key
az keyvault key create -n tdekey1 --vault-name kv-sqlserver-tde --protection hsm --size 2048 --kty RSA-HSM
# Grant permissions to the System Identity of Azure SQL Server
az keyvault set-policy -n kv-sqlserver-tde -g rg-sqlserver-tde  --object-id ee2680db-46e6-4ead-9365-05bb736761d0 --key-permissions wrapKey unwrapKey get
```
### 3. Add the Key Vault key to the server and set the TDE Protector
```bash
# Add the Key vault key to the Azure SQL server
az sql server key create -s sqlserver-abs -g rg-sqlserver-tde --kid https://kv-sqlserver-tde.vault.azure.net/keys/tdekey1/0ecd8de040e048d1a562a5e0c838e290
# Update encryption protector for Azure SQL Server & change TDE key from service-managed to customer-managed
az sql server tde-key set -s sqlserver-abs -g rg-sqlserver-tde --server-key-type AzureKeyVault --kid https://kv-sqlserver-tde.vault.azure.net/keys/tdekey1/0ecd8de040e048d1a562a5e0c838e290
```
![Alt text](/images/update-tde-protector.png)
### 4. Turn on TDE at the SQL DB
```bash
# Enable TDE at the database level with a customer-managed encryption key in Azure Key Vault
az sql db tde set --database sqldb-abs --server sqlserver-abs -g rg-sqlserver-tde --status Enabled
```
### 5. Check the encryption state and encryption activity
```bash
# get encryption scan progress
az sql db tde list-activity --database sqldb-abs --server sqlserver-abs -g rg-sqlserver-tde  

# get whether encryption is on or off
az sql db tde show --database sqldb-abs --server sqlserver-abs -g rg-sqlserver-tde
```

## Rotate the Transparent Data Encryption (TDE) protector
Rotating the logical TDE Protector for a server means switching to a new asymmetric key that protects the databases on the server. Key rotation is an online operation and should only take a few seconds to complete, because this only decrypts and re-encrypts the database's data encryption key, not the entire database.
Refer the [link](https://docs.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-byok-key-rotation?tabs=azure-cli)
```bash
# add a new key to Key Vault
az keyvault key create -n tdekey2 --vault-name kv-sqlserver-tde --protection hsm --size 3072 --kty RSA-HSM

# add the new key from Key Vault to the server
az sql server key create -s sqlserver-abs -g rg-sqlserver-tde --kid https://kv-sqlserver-tde.vault.azure.net/keys/tdekey2/79b628613b0644229231e30eef68ad7f

# set the key as the TDE protector for all resources under the server
az sql server tde-key set --server-key-type AzureKeyVault -s sqlserver-abs -g rg-sqlserver-tde --kid https://kv-sqlserver-tde.vault.azure.net/keys/tdekey2/79b628613b0644229231e30eef68ad7f
```

## Geo-DR and customer-managed TDE
In both active geo-replication and failover groups scenarios, each server involved requires a separate key vault, that must be co-located with the server in the same Azure region. Customer is responsible for keeping the key material across the key vaults consistent, so that geo-secondary is in sync and can take over using the same key from its local key vault if primary becomes inaccessible due to an outage in the region and a failover is triggered.

To avoid issues while establishing or during geo-replication due to incomplete key material, it's important to follow these rules when configuring customer-managed TDE:
* All key vaults involved must have same properties, and same access rights for respective servers.
* All key vaults involved must contain identical key material. It applies not just to the current TDE protector, but to the all previous TDE protectors that may be used in the backup files.
* Both initial setup and rotation of the TDE protector must be done on the secondary first, and then on primary.

![Alt text](/images/customer-managed-tde-with-bcdr.png)

## High availability with customer-managed TDE
Even in cases when there is no configured geo-redundancy for server, it is highly recommended to configure the server to use two different key vaults in two different regions with the same key material. The key in the secondary key vault in the other region should not be marked as TDE protector, and it's not even allowed. If there is an outage affecting the primary key vault, and only then, the system will automatically switch to the other linked key with the same thumbprint in the secondary key vault, if it exists.

**Providing the same key material to two key vaults in different regions can be done by creating the key outside of the key vault, and importing them into both key vaults.**

![Alt text](/images/customer-managed-tde-with-ha.png)

## Failover in case of Always Encrypted Database
In case of TDE, each server involved requires a separate key vault & the keys are required to bring up the Database itself. Once the DB is up, the metadata contained in the Column Master Key in the Always Encrypted DB will point to the same Always Encrypted Azure Key Vault, which will be auto restored by Microsoft to the paired region. Note that there is only one instance of AE Key Vault but there are two instances of TDE Key Vault.

![Alt text](/images/failover-tde-vs-ae.png)

## References
* [Azure SQL Transparent Data Encryption with customer-managed key](https://docs.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-byok-overview#doubleencryption)
* [Geo-DR and customer-managed TDE](https://docs.microsoft.com/en-ca/azure/azure-sql/database/transparent-data-encryption-byok-overview?view=sql-server-ver15#geo-dr-and-customer-managed-tde)
* [High availability with customer-managed TDE](https://docs.microsoft.com/en-ca/azure/azure-sql/database/transparent-data-encryption-byok-overview?view=sql-server-ver15#high-availability-with-customer-managed-tde)